<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Article page</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color-scheme: light dark; }
    body { margin: 0; padding: 2rem; }
    main { max-width: 820px; margin: 0 auto; }
    code { padding: .1rem .3rem; border-radius: .3rem; background: color-mix(in oklab, Canvas 92%, CanvasText 8%); }
  </style>
</head>
<body>
  <main>
    <h1 id="title">Article page (auto real-nav + seed to home)</h1>
    <p><a href="./index.html">Home</a></p>
    <p>Status: <code id="status">initializing…</code></p>
  </main>

  <script>
    (function () {
      const BASE = location.pathname.replace(/\/[^\/]*$/, '/');
      const HOME = BASE + 'index.html';
      const ARTICLE = BASE + 'article.html';
      const title = document.getElementById('title');
      const statusEl = document.getElementById('status');
      const url = new URL(location.href);
      const isSecondPass = url.searchParams.get('entry') === '1';

      function log() {
        console.log('[Article]', ...arguments);
      }
      function setStatus(t) {
        if (statusEl) statusEl.textContent = t;
        log(t);
      }

      // Always have popstate redirect to HOME once we have any guard
      window.addEventListener('popstate', () => {
        log('popstate → redirecting to', HOME);
        location.replace(HOME);
      });

      if (isSecondPass) {
        // We are on article.html?entry=1 after a real navigation.
        // Install a local guard (replace+push) so the first Back pops here → redirect to HOME.
        setStatus('second pass: installing local guard');
        try {
          history.replaceState({ trap: true, phase: 'second' }, '', location.href);
          history.pushState({ trap: true, guard: true, phase: 'second' }, '', location.href);
          setStatus('guard ready; Back will go to HOME');
          title.textContent = 'Article page (ready)';
        } catch (e) {
          setStatus('failed to install guard: ' + (e && e.message ? e.message : e));
        }
        return;
      }

      // FIRST PASS (no ?entry=1): Make the initial entry look like HOME, then perform a real navigation to ?entry=1.
      // This means the first Back will land on the HOME URL (a genuine entry), not a fake in-page URL.
      function firstPass() {
        setStatus('first pass: seeding initial entry to HOME then real-nav to ?entry=1');
        try {
          // Turn the current initial entry into HOME (URL bar shows HOME but content is article for a moment)
          history.replaceState({ trap: true, phase: 'seed-home' }, '', HOME);
          // Now perform a real navigation to article?entry=1 to create a true entry above the seeded HOME.
          const target = new URL(ARTICLE, location.origin);
          target.searchParams.set('entry', '1');
          // Use location.href instead of assign to keep a true entry
          log('navigating to', target.toString());
          location.href = target.toString();
        } catch (e) {
          setStatus('failed to seed/redirect: ' + (e && e.message ? e.message : e));
        }
      }

      // Trigger firstPass automatically after pageshow (covers load + bfcache). A tiny rAF ensures paint first.
      window.addEventListener('pageshow', (ev) => {
        log('pageshow (persisted:', !!ev.persisted, ')');
        if (!isSecondPass) {
          requestAnimationFrame(() => {
            requestAnimationFrame(firstPass);
          });
        }
      });

      // Safety: also try on classic load in case pageshow is missing in some webviews
      window.addEventListener('load', () => {
        if (!isSecondPass) {
          log('load fallback scheduling firstPass');
          setTimeout(() => {
            // if still not redirected
            if (location.search.indexOf('entry=1') === -1) firstPass();
          }, 50);
        }
      });
    })();
  </script>
</body>
</html>
